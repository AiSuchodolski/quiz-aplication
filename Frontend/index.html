<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikacja Quiz - System ZarzƒÖdzania Danymi i Quizami</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 150px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .data-preview {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .data-preview h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .data-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .data-actions {
            margin-top: 20px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            background: #f8f9fa;
            transition: all 0.3s ease;
            text-align: center;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f4ff;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin: 20px 0;
        }

        .file-item {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .file-item.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            font-size: 1.5em;
        }

        .supported-formats {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .supported-formats h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .format-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .format-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bbdefb;
            text-align: center;
        }

        .question-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .question-number {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .question-text {
            font-size: 1.3em;
            margin-bottom: 25px;
            color: #333;
            line-height: 1.5;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .answer-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .answer-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .answer-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .answer-option.correct {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }

        .answer-option.incorrect {
            border-color: #dc3545;
            background: #dc3545;
            color: white;
        }

        .score-display {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 1.1em;
            color: #1976d2;
            text-align: center;
            font-weight: bold;
        }

        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .final-score {
            font-size: 2.5em;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            width: 0%;
        }

        .rules {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .rules h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .rules ul {
            list-style-type: none;
            padding-left: 0;
        }

        .rules li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }

        .rules li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin: 5px;
        }

        .status-ready {
            background: #d4edda;
            color: #155724;
        }

        .status-empty {
            background: #fff3cd;
            color: #856404;
        }

        .status-no-data {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .answers-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .format-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Aplikacja Quiz</h1>
            <p>System zarzƒÖdzania danymi i quizami</p>
        </div>

        <div class="content">
            <!-- Ekran g≈Ç√≥wny -->
            <div id="mainScreen" class="screen active">
                <h2>Witaj w aplikacji Quiz!</h2>
                <p>Ta aplikacja pozwala Ci przesy≈Çaƒá pliki z materia≈Çami do nauki, zarzƒÖdzaƒá danymi i tworzyƒá quizy na ich podstawie.</p>
                
                <div class="rules">
                    <h3>Jak to dzia≈Ça:</h3>
                    <ul>
                        <li>Wprowad≈∫ sw√≥j klucz API OpenAI (bezpiecznie przechowywany tylko w Twojej przeglƒÖdarce)</li>
                        <li>Sprawd≈∫ zawarto≈õƒá aktualnych danych</li>
                        <li>Zdecyduj czy zachowaƒá istniejƒÖce dane czy je usunƒÖƒá</li>
                        <li>Prze≈õlij nowe pliki (PDF, DOCX, CSV, TXT)</li>
                        <li>Przetw√≥rz pliki i dodaj do bazy danych</li>
                        <li>Rozpocznij quiz na podstawie wszystkich danych</li>
                    </ul>
                </div>

                <div id="apiKeySection" style="background: #e3f2fd; border-radius: 15px; padding: 20px; margin: 20px 0;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">üîë Klucz API OpenAI</h3>
                    <div id="apiKeyInputContainer">
                        <input 
                            type="password" 
                            id="apiKeyInput" 
                            placeholder="Wprowad≈∫ sw√≥j klucz API OpenAI (np. sk-...)" 
                            style="width: 100%; padding: 12px; border: 2px solid #bbdefb; border-radius: 8px; font-size: 1em; margin-bottom: 10px;"
                        >
                        <button class="btn" onclick="saveApiKey()" style="width: 100%;">Zapisz klucz API</button>
                    </div>
                    <div id="apiKeySavedContainer" style="display: none; text-align: center;">
                        <p style="font-size: 1.2em; color: #28a745; font-weight: bold; margin: 10px 0;">
                            ‚úì Klucz API zapisany pomy≈õlnie!
                        </p>
                        <button class="btn btn-secondary" onclick="changeApiKey()" style="width: 100%; margin-top: 10px;">Zmie≈Ñ klucz API</button>
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        <strong>Bezpiecze≈Ñstwo:</strong> Tw√≥j klucz API jest przechowywany tylko w Twojej przeglƒÖdarce (sessionStorage) i nigdy nie jest zapisywany na serwerze.
                    </p>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="checkDataStatus()">Sprawd≈∫ dane</button>
                    <button class="btn btn-secondary" onclick="showUploadScreen()">Prze≈õlij pliki</button>
                </div>
            </div>

            <!-- Ekran sprawdzania danych -->
            <div id="dataScreen" class="screen">
                <h2>ZarzƒÖdzanie danymi</h2>
                
                <div id="dataStatus" class="data-preview">
                    <h3>Status danych</h3>
                    <div id="statusIndicator" class="status-indicator">Sprawdzanie...</div>
                </div>

                <div id="dataPreview" class="data-preview" style="display: none;">
                    <h3>PodglƒÖd zawarto≈õci data.txt</h3>
                    <div id="dataContent" class="data-content"></div>
                    <div class="data-actions">
                        <button class="btn btn-success" onclick="keepData()">Zachowaj dane</button>
                        <button class="btn btn-danger" onclick="clearData()">Usu≈Ñ dane</button>
                    </div>
                </div>

                <div id="dataMessage"></div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="backToMain()">Powr√≥t</button>
                    <button class="btn" onclick="showUploadScreen()">Prze≈õlij pliki</button>
                </div>
            </div>

            <!-- Ekran przesy≈Çania plik√≥w -->
            <div id="uploadScreen" class="screen">
                <h2>Przesy≈Çanie plik√≥w</h2>
                
                <div class="supported-formats">
                    <h3>Obs≈Çugiwane formaty:</h3>
                    <div class="format-list">
                        <div class="format-item">
                            <strong>üìÑ PDF</strong><br>
                            Dokumenty PDF
                        </div>
                        <div class="format-item">
                            <strong>üìù DOCX</strong><br>
                            Dokumenty Word
                        </div>
                        <div class="format-item">
                            <strong>üìä CSV</strong><br>
                            Arkusze danych
                        </div>
                        <div class="format-item">
                            <strong>üìÑ TXT</strong><br>
                            Pliki tekstowe
                        </div>
                    </div>
                </div>

                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3em; margin-bottom: 20px;">üìÅ</div>
                    <h3>PrzeciƒÖgnij plik tutaj lub kliknij aby wybraƒá</h3>
                    <p>Mo≈ºesz przes≈Çaƒá tylko jeden plik na raz</p>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf,.docx,.csv,.txt">
                </div>

                <div id="fileList" class="file-list"></div>
                <div id="uploadMessage"></div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="backToMain()">Powr√≥t</button>
                    <button class="btn" onclick="checkDataStatus()">Sprawd≈∫ dane</button>
                </div>
            </div>

            <!-- Ekran quizu -->
            <div id="quizScreen" class="screen">
                <div class="score-display">
                    <span id="currentScore">Wynik: 0/0</span>
                </div>
                
                <div class="question-card">
                    <div class="question-number" id="questionNumber">Pytanie 1</div>
                    <div class="question-text" id="questionText">≈Åadowanie pytania...</div>
                    
                    <div class="answers-grid" id="answersGrid">
                        <!-- Odpowiedzi bƒôdƒÖ dodawane dynamicznie -->
                    </div>
                    
                    <div id="feedback" class="feedback" style="display: none;"></div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">Nastƒôpne pytanie</button>
                    <button class="btn btn-danger" onclick="quitQuiz()" style="margin-top: 10px;">Zako≈Ñcz quiz</button>
                </div>
            </div>

            <!-- Ekran wynik√≥w -->
            <div id="resultScreen" class="screen">
                <h2>üéâ Quiz zako≈Ñczony!</h2>
                <div class="final-score" id="finalScore">0/0</div>
                <div id="resultMessage" style="text-align: center; font-size: 1.2em; margin: 20px 0;"></div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="restartQuiz()">Zagraj ponownie</button>
                    <button class="btn btn-secondary" onclick="backToMain()">Powr√≥t do g≈Ç√≥wnego menu</button>
                </div>
            </div>

            <!-- Komunikaty b≈Çƒôd√≥w -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Auto-detect API URL: use environment variable or default to production
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5003'
            : 'https://quiz-backend-rn63.onrender.com'; // ZastƒÖp to URL twojego Render app
        
        console.log('Using API URL:', API_BASE_URL);
        
        let currentQuestionData = null;
        let selectedAnswer = null;
        let totalQuestions = 0;
        let currentScore = 0;
        let currentFileName = null;
        let isProcessing = false;

        // ZarzƒÖdzanie kluczem API
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showError('Proszƒô wprowadziƒá klucz API');
                return;
            }
            if (!apiKey.startsWith('sk-')) {
                if (confirm('Klucz API OpenAI zazwyczaj zaczyna siƒô od "sk-". Czy na pewno chcesz kontynuowaƒá?')) {
                    sessionStorage.setItem('openai_api_key', apiKey);
                    document.getElementById('apiKeyInputContainer').style.display = 'none';
                    document.getElementById('apiKeySavedContainer').style.display = 'block';
                    showSuccess('Klucz API zosta≈Ç zapisany bezpiecznie!');
                }
            } else {
                sessionStorage.setItem('openai_api_key', apiKey);
                document.getElementById('apiKeyInputContainer').style.display = 'none';
                document.getElementById('apiKeySavedContainer').style.display = 'block';
                showSuccess('Klucz API zosta≈Ç zapisany bezpiecznie!');
            }
        }

        function changeApiKey() {
            document.getElementById('apiKeyInputContainer').style.display = 'block';
            document.getElementById('apiKeySavedContainer').style.display = 'none';
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('apiKeyInput').focus();
        }

        function getApiKey() {
            return sessionStorage.getItem('openai_api_key');
        }

        function checkApiKey() {
            const apiKey = getApiKey();
            if (!apiKey) {
                showError('Proszƒô najpierw wprowadziƒá i zapisaƒá klucz API OpenAI');
                return false;
            }
            return true;
        }

        // Helper function to get headers with API key
        function getHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            const apiKey = getApiKey();
            if (apiKey) {
                headers['X-OpenAI-API-Key'] = apiKey;
            }
            return headers;
        }

        // Inicjalizacja aplikacji
        window.addEventListener('DOMContentLoaded', async function() {
            // Sprawd≈∫ czy klucz API jest ju≈º zapisany
            const savedKey = getApiKey();
            if (savedKey) {
                document.getElementById('apiKeyInputContainer').style.display = 'none';
                document.getElementById('apiKeySavedContainer').style.display = 'block';
            }
            
            try {
                await fetch(`${API_BASE_URL}/quiz/start`);
                console.log('Upload folder zosta≈Ç wyczyszczony');
            } catch (error) {
                console.error('B≈ÇƒÖd podczas czyszczenia folderu upload:', error);
            }
        });

        // Funkcje pomocnicze
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            // Sprawd≈∫ kt√≥ry ekran jest aktywny
            const uploadMessage = document.getElementById('uploadMessage');
            const dataMessage = document.getElementById('dataMessage');
            
            if (uploadMessage && document.getElementById('uploadScreen').classList.contains('active')) {
                uploadMessage.innerHTML = `<div class="success-message">${message}</div>`;
            } else if (dataMessage && document.getElementById('dataScreen').classList.contains('active')) {
                dataMessage.innerHTML = `<div class="success-message">${message}</div>`;
            } else if (uploadMessage) {
                // Fallback do uploadMessage je≈õli aktywny jest inny ekran
                uploadMessage.innerHTML = `<div class="success-message">${message}</div>`;
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function backToMain() {
            showScreen('mainScreen');
        }

        // Sprawdzanie statusu danych
        async function checkDataStatus() {
            try {
                showScreen('dataScreen');
                const statusIndicator = document.getElementById('statusIndicator');
                statusIndicator.textContent = 'Sprawdzanie...';
                statusIndicator.className = 'status-indicator';
                
                // Wyczy≈õƒá komunikaty z poprzedniego ekranu
                document.getElementById('dataMessage').innerHTML = '';

                const response = await fetch(`${API_BASE_URL}/quiz/processing`);
                const result = await response.json();

                const dataPreview = document.getElementById('dataPreview');
                const dataContent = document.getElementById('dataContent');

                if (result.status === 'success' && result.has_data) {
                    statusIndicator.textContent = 'Dane dostƒôpne';
                    statusIndicator.className = 'status-indicator status-ready';
                    dataPreview.style.display = 'block';
                    dataContent.textContent = result.data;
                } else if (result.status === 'empty') {
                    statusIndicator.textContent = 'Brak danych';
                    statusIndicator.className = 'status-indicator status-empty';
                    dataPreview.style.display = 'none';
                } else {
                    statusIndicator.textContent = 'Brak danych';
                    statusIndicator.className = 'status-indicator status-no-data';
                    dataPreview.style.display = 'none';
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas sprawdzania danych: ' + error.message);
            }
        }

        // Zachowanie danych
        async function keepData() {
            try {
                const response = await fetch(`${API_BASE_URL}/quiz/processing`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_decision: true
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showSuccess('Dane zosta≈Çy zachowane!');
                    setTimeout(() => {
                        showDataKeptOptions();
                    }, 1500);
                } else {
                    showError('B≈ÇƒÖd podczas zachowywania danych');
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas zachowywania danych: ' + error.message);
            }
        }

        // Poka≈º opcje po zachowaniu danych
        function showDataKeptOptions() {
            const messageDiv = document.getElementById('dataMessage');
            messageDiv.innerHTML = `
                <div class="success-message" style="margin-bottom: 20px;">
                    Dane zosta≈Çy zachowane! Co chcesz zrobiƒá dalej?
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="startQuiz()">Rozpocznij quiz</button>
                    <button class="btn" onclick="showUploadScreen()">Dodaj wiƒôcej plik√≥w</button>
                    <button class="btn btn-secondary" onclick="backToMain()">Powr√≥t do menu</button>
                </div>
            `;
        }

        // Usuwanie danych
        async function clearData() {
            try {
                const response = await fetch(`${API_BASE_URL}/quiz/processing`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_decision: false
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showSuccess('Dane zosta≈Çy usuniƒôte!');
                    setTimeout(() => {
                        showUploadScreen();
                    }, 1500);
                } else {
                    showError('B≈ÇƒÖd podczas usuwania danych');
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas usuwania danych: ' + error.message);
            }
        }

        // Pokazanie ekranu przesy≈Çania
        function showUploadScreen() {
            showScreen('uploadScreen');
            // Resetuj stan upload
            currentFileName = null;
            isProcessing = false;
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('uploadMessage').innerHTML = '';
            setupFileUpload();
        }

        // Konfiguracja przesy≈Çania plik√≥w
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Usu≈Ñ poprzednie event listenery aby uniknƒÖƒá duplikat√≥w
            uploadArea.removeEventListener('click', handleUploadAreaClick);
            uploadArea.removeEventListener('dragover', handleDragOver);
            uploadArea.removeEventListener('dragleave', handleDragLeave);
            uploadArea.removeEventListener('drop', handleDrop);
            fileInput.removeEventListener('change', handleFileInputChange);

            // Dodaj nowe event listenery
            uploadArea.addEventListener('click', handleUploadAreaClick);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileInputChange);
        }

        // Event handler dla klikniƒôcia w upload area
        function handleUploadAreaClick() {
            document.getElementById('fileInput').click();
        }

        // Event handler dla drag over
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        // Event handler dla drag leave
        function handleDragLeave() {
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        // Event handler dla drop
        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        // Event handler dla zmiany input file
        function handleFileInputChange(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
                // Wyczy≈õƒá input aby mo≈ºna by≈Ço wybraƒá ten sam plik ponownie
                e.target.value = '';
            }
        }

        // Obs≈Çuga wybranego pliku
        function handleFile(file) {
            if (isProcessing) {
                showError('Plik jest ju≈º przetwarzany. Poczekaj chwilƒô.');
                return;
            }

            if (!isValidFileType(file)) {
                showError(`Nieobs≈Çugiwany format pliku: ${file.name}`);
                return;
            }

            // Sprawd≈∫ czy plik ju≈º zosta≈Ç przes≈Çany
            if (currentFileName === file.name) {
                showError(`Plik ${file.name} zosta≈Ç ju≈º przes≈Çany`);
                return;
            }

            currentFileName = file.name;
            isProcessing = true;
            uploadFile(file);
        }

        // Sprawdzenie typu pliku
        function isValidFileType(file) {
            const validTypes = ['.pdf', '.docx', '.csv', '.txt'];
            const fileName = file.name.toLowerCase();
            return validTypes.some(type => fileName.endsWith(type));
        }

        // Przesy≈Çanie pliku
        async function uploadFile(file) {
            try {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">${getFileIcon(file.name)}</span>
                        <span>${file.name}</span>
                    </div>
                    <div class="loading"></div>
                `;
                fileList.appendChild(fileItem);

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE_URL}/quiz/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('Upload result:', result);

                if (result.status === 'success') {
                    fileItem.classList.add('success');
                    fileItem.querySelector('.loading').innerHTML = '‚úÖ';
                    showSuccess(`Plik ${file.name} zosta≈Ç przes≈Çany pomy≈õlnie!`);
                    
                    // Automatycznie przetw√≥rz plik
                    setTimeout(() => {
                        processFile(file.name);
                    }, 1000);
                } else {
                    throw new Error(result.message || 'B≈ÇƒÖd podczas przesy≈Çania pliku');
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas przesy≈Çania pliku: ' + error.message);
                const fileItem = document.querySelector('.file-item');
                if (fileItem) {
                    fileItem.classList.add('error');
                    fileItem.querySelector('.loading').innerHTML = '‚ùå';
                }
                isProcessing = false;
            }
        }

        // Ikona pliku
        function getFileIcon(fileName) {
            const ext = fileName.toLowerCase().split('.').pop();
            const icons = {
                'pdf': 'üìÑ',
                'docx': 'üìù',
                'csv': 'üìä',
                'txt': 'üìÑ'
            };
            return icons[ext] || 'üìÑ';
        }

        // Przetwarzanie pliku
        async function processFile(fileName) {
            try {
                showSuccess(`Przetwarzanie pliku ${fileName}...`);

                // Zapisz dane z pliku do data.txt
                const writeResponse = await fetch(`${API_BASE_URL}/quiz/write_data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: fileName
                    })
                });

                const writeResult = await writeResponse.json();
                console.log('Write data result:', writeResult);
                if (writeResult.status !== 'success') {
                    throw new Error(writeResult.message || 'B≈ÇƒÖd podczas zapisywania danych');
                }

                // Usu≈Ñ plik z folderu upload
                const deleteResponse = await fetch(`${API_BASE_URL}/quiz/delete_upload_file`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: fileName
                    })
                });

                const deleteResult = await deleteResponse.json();
                if (deleteResult.status !== 'success') {
                    console.warn('Nie uda≈Ço siƒô usunƒÖƒá pliku z upload:', deleteResult.message);
                }

                showSuccess(`Plik ${fileName} zosta≈Ç przetworzony i dodany do bazy danych!`);
                
                // Resetuj stan przetwarzania
                isProcessing = false;
                
                // Poka≈º opcje po przetworzeniu pliku
                setTimeout(() => {
                    showFileProcessedOptions();
                }, 2000);

            } catch (error) {
                console.error('Error in processFile:', error);
                showError('B≈ÇƒÖd podczas przetwarzania pliku: ' + error.message);
                isProcessing = false;
                currentFileName = null;
                // Usu≈Ñ spinner i poka≈º komunikat b≈Çƒôdu
                const fileItem = document.querySelector('.file-item');
                if (fileItem) {
                    const spinner = fileItem.querySelector('.loading');
                    if (spinner) {
                        spinner.innerHTML = '‚ùå';
                    }
                    fileItem.classList.add('error');
                }
            }
        }

        // Poka≈º opcje po przetworzeniu pliku
        function showFileProcessedOptions() {
            const messageDiv = document.getElementById('uploadMessage');
            messageDiv.innerHTML = `
                <div class="success-message" style="margin-bottom: 20px;">
                    Plik zosta≈Ç przetworzony pomy≈õlnie! Co chcesz zrobiƒá dalej?
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="startQuiz()">Rozpocznij quiz</button>
                    <button class="btn" onclick="resetUploadAndContinue()">Prze≈õlij kolejny plik</button>
                </div>
            `;
        }

        // Resetuj upload i kontynuuj
        function resetUploadAndContinue() {
            currentFileName = null;
            isProcessing = false;
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('uploadMessage').innerHTML = '';
            showUploadScreen();
        }

        // Rozpoczƒôcie quizu
        async function startQuiz() {
            if (!checkApiKey()) {
                return;
            }
            try {
                const apiKey = getApiKey();
                const response = await fetch(`${API_BASE_URL}/quiz/start`, {
                    headers: {
                        'X-OpenAI-API-Key': apiKey
                    }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showScreen('quizScreen');
                    // Inicjalizuj wynik na poczƒÖtku quizu
                    currentScore = 0;
                    totalQuestions = 0;
                    document.getElementById('currentScore').textContent = 'Wynik: 0/0';
                    loadQuestion();
                } else {
                    showError('B≈ÇƒÖd podczas rozpoczynania quizu');
                }
            } catch (error) {
                showError('Nie mo≈ºna po≈ÇƒÖczyƒá siƒô z serwerem. Sprawd≈∫ czy backend jest uruchomiony.');
            }
        }

        // ≈Åadowanie pytania
        async function loadQuestion() {
            try {
                document.getElementById('questionText').textContent = '≈Åadowanie pytania...';
                document.getElementById('answersGrid').innerHTML = '';
                document.getElementById('feedback').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'none';
                
                const apiKey = getApiKey();
                const response = await fetch(`${API_BASE_URL}/quiz/question`, {
                    headers: {
                        'X-OpenAI-API-Key': apiKey
                    }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentQuestionData = data;
                    displayQuestion(data);
                } else {
                    const errorMsg = data.message || 'B≈ÇƒÖd podczas ≈Çadowania pytania';
                    showError(errorMsg);
                    // Je≈õli to b≈ÇƒÖd zwiƒÖzany z kluczem API, wr√≥ƒá do ekranu g≈Ç√≥wnego
                    if (response.status === 400 || errorMsg.includes('klucz API')) {
                        setTimeout(() => {
                            backToMain();
                        }, 3000);
                    }
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas ≈Çadowania pytania: ' + error.message);
            }
        }

        // Wy≈õwietlenie pytania
        function displayQuestion(data) {
            document.getElementById('questionNumber').textContent = `Pytanie ${data.number_of_questions}`;
            document.getElementById('questionText').textContent = data.question;
            
            const answersGrid = document.getElementById('answersGrid');
            answersGrid.innerHTML = '';
            
            Object.entries(data.answers).forEach(([key, value]) => {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-option';
                answerDiv.innerHTML = `<strong>${key}.</strong> ${value}`;
                answerDiv.onclick = () => selectAnswer(key, answerDiv);
                answersGrid.appendChild(answerDiv);
            });
            
            selectedAnswer = null;
        }

        // Wyb√≥r odpowiedzi
        function selectAnswer(answer, element) {
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedAnswer = answer;
            
            submitAnswer();
        }

        // Wys≈Çanie odpowiedzi
        async function submitAnswer() {
            if (!selectedAnswer) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/quiz/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_answer: selectedAnswer
                    })
                });
                
                const result = await response.json();
                displayFeedback(result);
                updateScore();
                
            } catch (error) {
                showError('B≈ÇƒÖd podczas wysy≈Çania odpowiedzi: ' + error.message);
            }
        }

        // Wy≈õwietlenie feedbacku
        function displayFeedback(result) {
            const feedbackDiv = document.getElementById('feedback');
            const answerOptions = document.querySelectorAll('.answer-option');
            
            answerOptions.forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            answerOptions.forEach(option => {
                const optionLetter = option.textContent.charAt(0);
                if (optionLetter === result.correct_answer) {
                    option.classList.add('correct');
                } else if (optionLetter === selectedAnswer && !result.is_correct) {
                    option.classList.add('incorrect');
                }
            });
            
            feedbackDiv.textContent = result.message;
            if (!result.is_correct) {
                feedbackDiv.textContent += ` Poprawna odpowied≈∫: ${result.correct_answer}`;
            }
            feedbackDiv.className = `feedback ${result.is_correct ? 'correct' : 'incorrect'}`;
            feedbackDiv.style.display = 'block';
            
            document.getElementById('nextBtn').style.display = 'inline-block';
        }

        // Aktualizacja wyniku
        async function updateScore() {
            try {
                const response = await fetch(`${API_BASE_URL}/quiz/result`);
                const data = await response.json();
                
                if (data.status === 'success' && data.result) {
                    currentScore = data.result['Zdobyte punkty'];
                    totalQuestions = data.result['Liczba pyta≈Ñ'];
                    
                    document.getElementById('currentScore').textContent = 
                        `Wynik: ${currentScore}/${totalQuestions}`;
                } else {
                    console.error('Nieprawid≈Çowy format odpowiedzi:', data);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd podczas aktualizacji wyniku:', error);
            }
        }

        // Nastƒôpne pytanie
        function nextQuestion() {
            loadQuestion();
        }

        // Zako≈Ñczenie quizu
        function quitQuiz() {
            showResults();
        }

        // Wy≈õwietlenie wynik√≥w
        function showResults() {
            showScreen('resultScreen');
            
            document.getElementById('finalScore').textContent = `${currentScore}/${totalQuestions}`;
            
            const percentage = totalQuestions > 0 ? Math.round((currentScore / totalQuestions) * 100) : 0;
            let message = '';
            
            if (percentage >= 80) {
                message = '≈öwietny wynik! üåü';
            } else if (percentage >= 60) {
                message = 'Dobra robota! üëç';
            } else if (percentage >= 40) {
                message = 'Niez≈Çy wynik! üìö';
            } else {
                message = 'Warto poƒáwiczyƒá wiƒôcej! üí™';
            }
            
            document.getElementById('resultMessage').textContent = message;
        }

        // Restart quizu
        function restartQuiz() {
            showScreen('quizScreen');
            currentScore = 0;
            totalQuestions = 0;
            selectedAnswer = null;
            currentQuestionData = null;
            loadQuestion();
        }

        // Skr√≥ty klawiszowe
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('quizScreen').classList.contains('active')) {
                const key = event.key.toLowerCase();
                if (['a', 'b', 'c', 'd'].includes(key)) {
                    const answerOptions = document.querySelectorAll('.answer-option');
                    answerOptions.forEach(option => {
                        if (option.textContent.toLowerCase().startsWith(key)) {
                            option.click();
                        }
                    });
                } else if (key === 'q') {
                    quitQuiz();
                }
            }
        });
    </script>
</body>
</html>
